version: '3.8'

services:
  validator:
    image: alpine:latest
    container_name: nixos-home-server-validator
    network_mode: host
    command: >
      sh -c "
      echo '============================================';
      echo 'NixOS Home Server Installation Validator';
      echo '============================================';
      echo '';
      
      # Install required tools
      apk add --no-cache curl jq bind-tools 2>/dev/null;
      
      # Color codes
      GREEN='\033[0;32m';
      RED='\033[0;31m';
      YELLOW='\033[1;33m';
      NC='\033[0m';
      
      # Test function
      test_service() {
        local name=$$1;
        local url=$$2;
        local expected_code=$$3;
        
        echo -n \"Testing $$name... \";
        
        response=$$(curl -s -o /dev/null -w '%{http_code}' --connect-timeout 5 --max-time 10 $$url 2>/dev/null);
        
        if [ \"$$response\" = \"$$expected_code\" ] || [ \"$$response\" = \"200\" ] || [ \"$$response\" = \"302\" ]; then
          echo \"$${GREEN}✓ PASSED$${NC} (HTTP $$response)\";
          return 0;
        else
          echo \"$${RED}✗ FAILED$${NC} (HTTP $$response)\";
          return 1;
        fi
      }
      
      # Test DNS
      test_dns() {
        echo -n 'Testing Pi-hole DNS... ';
        if nslookup google.com 127.0.0.1 >/dev/null 2>&1; then
          echo \"$${GREEN}✓ PASSED$${NC}\";
          return 0;
        else
          echo \"$${RED}✗ FAILED$${NC}\";
          return 1;
        fi
      }
      
      echo '';
      echo 'Running service checks...';
      echo '';
      
      # Initialize counters
      passed=0;
      failed=0;
      
      # Test each service
      if test_service 'Home Assistant' 'http://localhost:8123' '200'; then passed=$$((passed+1)); else failed=$$((failed+1)); fi;
      if test_service 'Jellyfin' 'http://localhost:8096' '302'; then passed=$$((passed+1)); else failed=$$((failed+1)); fi;
      if test_service 'Kavita' 'http://localhost:5000' '200'; then passed=$$((passed+1)); else failed=$$((failed+1)); fi;
      if test_service 'Nextcloud' 'http://localhost:8080' '200'; then passed=$$((passed+1)); else failed=$$((failed+1)); fi;
      if test_service 'Pi-hole Web UI' 'http://localhost:8181' '200'; then passed=$$((passed+1)); else failed=$$((failed+1)); fi;
      
      echo '';
      if test_dns; then passed=$$((passed+1)); else failed=$$((failed+1)); fi;
      
      # Check Docker
      echo '';
      echo 'Checking Docker containers...';
      echo '';
      
      # Check for running containers
      if command -v docker >/dev/null 2>&1; then
        echo 'Expected containers:';
        echo '  - homeassistant';
        echo '  - jellyfin';
        echo '  - kavita';
        echo '  - nextcloud-aio-mastercontainer';
        echo '  - pihole';
        echo '';
        echo \"$${YELLOW}Note: Run 'docker ps' on the host to verify containers are running$${NC}\";
      else
        echo \"$${YELLOW}Docker CLI not available in container (this is expected)$${NC}\";
        echo \"$${YELLOW}Run 'sudo docker ps' on the host to verify containers$${NC}\";
      fi
      
      # Summary
      echo '';
      echo '============================================';
      echo 'Validation Summary';
      echo '============================================';
      echo \"Tests passed: $${GREEN}$$passed$${NC}\";
      echo \"Tests failed: $${RED}$$failed$${NC}\";
      echo '';
      
      if [ $$failed -eq 0 ]; then
        echo \"$${GREEN}✓ All tests passed! Your home server is ready.$${NC}\";
        echo '';
        echo 'Access your services at:';
        echo '  - Home Assistant: http://localhost:8123/';
        echo '  - Jellyfin: http://localhost:8096/';
        echo '  - Kavita: http://localhost:5000/home';
        echo '  - Nextcloud: http://localhost:8080/';
        echo '  - Pi-hole: http://localhost:8181/';
        exit 0;
      else
        echo \"$${RED}✗ Some tests failed. Please check the logs above.$${NC}\";
        echo '';
        echo 'Troubleshooting steps:';
        echo '  1. Check if services are running: sudo systemctl status <service>-docker';
        echo '  2. Check Docker containers: sudo docker ps';
        echo '  3. Check logs: sudo journalctl -u <service>-docker -f';
        echo '  4. Restart services: sudo systemctl restart <service>-docker';
        exit 1;
      fi
      "
    restart: "no"
